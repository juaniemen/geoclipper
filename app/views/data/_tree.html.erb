<script>

  $(document).ready(function () {
// Some logic to retrieve, or generate tree structure
    var tree = <%= raw @tree_view.to_json %>;
    var selectedNode;
    var idPath;
    var nodeAux;


    function scan(obj) {
      var k = 'text';
      if (obj instanceof Object) {
        for (k in obj) {
          if (obj.hasOwnProperty(k)) {
            //recursive call to scan property
            scan(obj[k]);
            if (obj[k] != null) {
              obj[k].selectable = false;
              if (obj[k].nodes == null) {
                obj[k].selectable = true;
              }
            }
          }
        }
      } else {
        //not an Object so obj[k] here is a value
      }
      ;

    };

    scan(tree)

    var a = $('#tree').treeview({
      data: tree,
      backColor: '#93C54B',
    });

    a;

    $('#tree').on('nodeSelected', function (event, data) {
      selectedNode = data['nodeId'].toString();
      nodeAux = data['nodeId']
      idPath = getPathNode();
      $('#mapModal').modal('show');


    });

    function loadMap2() {
      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([37.41, 8.82]),
          zoom: 4
        })
      });
    };
    data1 = '';
    function loadMap() {
      url1 = '/data/jsonToMap/' + idPath

//      var vectorLayer = new ol.layer.Vector({
//        source: new ol.source.Vector({
//          format: new ol.format.GeoJSON(),
//          url: url1
//        }),
//        style: new ol.style.Style({
//          image: new ol.style.Circle( /** @type {olx.style.IconOptions} */ ({
//            radius: 20,
//            fill: new ol.style.Fill({
//              color: '#ffff00'
//            })
//          }))
//        })
//      });

      var map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source:  new ol.source.OSM({})
          })
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([37.41, 8.82]),
          zoom: 4
        })
      });

      map.zoomToMaxExtent();
    };


//    function llamadaAsynGeoJson() {
//      url = '/data/jsonToMap/' + idPath
//      $.get('url'), {
//        data: {format: 'json'},
//        success: function (data) {
//          data1 = data;
//          loadMap(data);
//          alert('Me ha llegado')
//        },
//        error: function () {
//          alert('No se pudo cargar el mapa')
//        }
//      };
//
//    }

    $('#mapModal').on('shown.bs.modal', function () {
      loadMap();
//      llamadaAsynGeoJson();


    });

    $('#mapModal').on('hidden.bs.modal', function () {


      $('#map').empty();
      $('#tree').treeview('unselectNode', [nodeAux, {silent: false}]);
      selectedNode = null;
      nodeAux = null;
//      $('#result').empty();
    });

    function getPathNode() {
      node = $('#tree').treeview('getNode', selectedNode);
      resultAux = getPathNodeAux(node, '');
      return resultAux.substr(0, resultAux.length - 1);
    };


    function getPathNodeAux(node, pathNode) {
      pathNode1 = node['text'] + "_" + pathNode;
      node1 = $('#tree').treeview('getParent', node);
      if (node1['nodeId'] == 0) {
        return pathNode1;
      } else {
        return getPathNodeAux(node1, pathNode1);
      }
    }
  });


</script>

